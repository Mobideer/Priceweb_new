{% extends "base.html" %}

{% block content %}
<div class="status-bar">
    <div class="stats">
        <span title="{{ status.db_path }}">DB: <b>{{ status.db_path.split('/')[-1] }}</b></span>
        <span>Items: <b>{{ status.items_db }}</b></span>
        <span>Last Run: <b>{{ status.worker_last_run_ts | format_ts }}</b></span>
        <span class="status-indicator"
            style="color: {% if status.ok %}var(--success-color){% else %}var(--danger-color){% endif %};">
            ‚óè {% if status.ok %}System OK{% else %}{{ status.error }}{% endif %}
        </span>
        <span style="opacity: 0.5; font-size: 0.85em; margin-left: auto;">v{{ status.version }}</span>
        <div class="actions">
            <button id="reloadBtn" type="button" onclick="triggerReload(event)" class="btn-reload">Reload Data</button>
            <button type="button" onclick="showLogs()" class="btn-logs">View Logs</button>
            <span id="reloadStatus" class="status-text"></span>
        </div>
    </div>
</div>

<!-- Log Modal -->
<div id="logModal" class="modal"
    style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter: blur(4px);">
    <div
        style="background:var(--bg-card); margin: 5% auto; padding: 20px; border: 1px solid var(--border-color); width: 80%; max-width: 900px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">Worker Logs (Last 100 lines)</h3>
            <span onclick="closeLogs()" style="cursor:pointer; font-size:24px; opacity:0.6;">&times;</span>
        </div>
        <pre id="logContent"
            style="background:#000; color:#0f0; padding:15px; border-radius:4px; max-height:500px; overflow-y:auto; font-family:monospace; font-size:12px; white-space:pre-wrap;"></pre>
        <div style="text-align:right; margin-top:15px;">
            <button onclick="closeLogs()" class="primary">Close</button>
        </div>
    </div>
</div>

<form id="searchForm" class="toolbar" method="get" action="/"
    style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
    <input type="text" id="searchInput" name="q" placeholder="Live Search SKU or Name..." value="{{ q }}" size="40"
        autocomplete="off" style="flex: 2; min-width: 200px;">

    <input id="filter-our-price" placeholder="Our Price: >1000 q>0"
        style="flex: 1; min-width: 150px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-card); color: var(--text-color);">

    <input id="filter-mysklad" placeholder="MySklad: >1000 q>0"
        style="flex: 1; min-width: 150px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-card); color: var(--text-color);">

    <select name="limit" onchange="this.form.submit()" style="flex: 0 0 auto;">
        <option value="20" {% if limit==20 %}selected{% endif %}>20</option>
        <option value="50" {% if limit==50 %}selected{% endif %}>50</option>
        <option value="100" {% if limit==100 %}selected{% endif %}>100</option>
    </select>
    </select>
    <button type="button" onclick="clearFilters()" class="btn-page"
        style="flex: 0 0 auto; border: 1px solid var(--danger-color); color: var(--danger-color); background: transparent;">‚úñ
        Clear</button>
    <button type="submit" class="primary" style="flex: 0 0 auto;">Search</button>
</form>

<script>
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('filter-our-price').value = '';
        document.getElementById('filter-mysklad').value = '';
        fetchData(1);
    }
</script>

<div class="table-container">
    <table>
        <thead>
            <style>
                .dropdown {
                    position: relative;
                    display: inline-block;
                }

                .dropdown-content {
                    display: none;
                    position: absolute;
                    background-color: var(--bg-card);
                    min-width: 160px;
                    box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2);
                    z-index: 1;
                    border: 1px solid var(--border-color);
                    border-radius: 4px;
                    left: 0;
                    top: 100%;
                }

                .dropdown-content div {
                    color: var(--text-color);
                    padding: 12px 16px;
                    text-decoration: none;
                    display: block;
                    cursor: pointer;
                }

                .dropdown-content div:hover {
                    background-color: var(--hover-color);
                }

                .show {
                    display: block;
                }
            </style>
            <tr>
                <th style="width: 35%;">
                    <div class="dropdown">
                        <span onclick="toggleSortMenu()" style="cursor: pointer; user-select: none;">
                            Product <span id="sort-indicator">‚ñº</span>
                        </span>
                        <div id="sortDropdown" class="dropdown-content">
                            <div onclick="handleSort('sku'); toggleSortMenu()">By SKU/Article</div>
                            <div onclick="handleSort('name'); toggleSortMenu()">By Name</div>
                            <div onclick="handleSort('created_at'); toggleSortMenu()">By Date Created</div>
                        </div>
                    </div>
                </th>
                <th style="width: 20%; cursor: pointer; text-align: right;" onclick="handleSort('our_price')">
                    Our Price <span id="sort-our_price" class="sort-icon">‚áÖ</span>
                </th>
                <th style="width: 20%; cursor: pointer; text-align: right;" onclick="handleSort('my_sklad_price')">
                    MySklad <span id="sort-my_sklad_price" class="sort-icon">‚áÖ</span>
                </th>
                <th style="width: 20%; cursor: pointer; text-align: right;" onclick="handleSort('min_sup_supplier')">
                    Supplier <span id="sort-min_sup_supplier" class="sort-icon">‚áÖ</span>
                </th>
                <th style="width: 5%;"></th>
            </tr>
            <!-- Filter row removed and moved to toolbar -->
        </thead>
        <tbody id="resultsBody">
            {% for item in items %}
            <tr class="product-row" style="cursor: pointer;" onclick="toggleDetails('{{ item.sku }}')">
                <td data-label="Product">
                    <div style="font-weight: bold; color: var(--accent-color); font-size: 1.1em; margin-bottom: 4px;">{{
                        item.name }}</div>
                    <div style="font-size: 0.85em; opacity: 0.7;">SKU: {{ item.sku }} | Created: {{
                        item.created_at|format_ts }} | Updated: {{
                        item.updated_at|format_ts }}</div>
                </td>
                <td data-label="–ù–∞—à–∞ —Ü–µ–Ω–∞" style="text-align: right; vertical-align: middle;">
                    <div style="font-size: 1.2em; font-weight: bold;">{{ item.our_price }} ‚ÇΩ</div>
                    <div style="font-size: 0.8em; opacity: 0.6;">–∫–æ–ª-–≤–æ: {{ item.our_qty }}</div>
                </td>
                <td data-label="–ú–æ–π –°–∫–ª–∞–¥" style="text-align: right; vertical-align: middle;">
                    <div
                        style="font-weight: bold; color: {% if item.my_sklad_qty > 0 %}#4caf50{% else %}#888{% endif %};">
                        {{ item.my_sklad_price }} ‚ÇΩ
                    </div>
                    <div style="font-size: 0.8em; opacity: 0.6;">–∫–æ–ª-–≤–æ: {{ item.my_sklad_qty }}</div>
                </td>
                <td data-label="–ü–æ—Å—Ç–∞–≤—â–∏–∫" style="text-align: right; vertical-align: middle;">
                    <div style="font-weight: bold;">{{ item.min_sup_price if item.min_sup_price else 'N/A' }}{% if
                        item.min_sup_price %} ‚ÇΩ{% endif %}</div>
                    <div style="font-size: 0.8em; opacity: 0.7;">{{ item.min_sup_supplier or '-' }} {{ item.sup_stats }}
                    </div>
                </td>
                <td data-label="" style="text-align: center; vertical-align: middle;">
                    <button class="btn-action"
                        style="background: transparent; border: 1px solid #888; color: #888; cursor: pointer; border-radius: 4px; padding: 4px 8px;">‚ñº</button>
                </td>
            </tr>
            <tr id="details-{{ item.sku }}" class="details-row" style="display: none;">
                <td colspan="5"
                    style="padding: 10px 20px; border-bottom: 2px solid var(--border-color); background: rgba(0,0,0,0.1);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; opacity: 0.8;">–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</h4>
                        <button class="btn-action" onclick="showHistory('{{ item.sku }}')"
                            style="background: var(--bg-card); border: 1px solid var(--accent-color); color: var(--accent-color); cursor: pointer; border-radius: 4px; padding: 6px 12px; font-weight: bold;">üìä
                            –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ü–µ–Ω</button>
                    </div>
                    <table class="suppliers-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <th style="text-align: left; padding: 8px;">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                <th style="text-align: left; padding: 8px;">–ê—Ä—Ç–∏–∫—É–ª</th>
                                <th style="text-align: right; padding: 8px;">–¶–µ–Ω–∞</th>
                                <th style="text-align: right; padding: 8px;">–∫–æ–ª-–≤–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set raw_suppliers = item.suppliers_json|fromjson %}
                            {# Filter out My Sklad #}
                            {% set filtered_sups = [] %}
                            {% for s in raw_suppliers %}
                            {% if s.supplier.lower() != '–º–æ–π —Å–∫–ª–∞–¥' %}
                            {% set _ = filtered_sups.append(s) %}
                            {% endif %}
                            {% endfor %}

                            {# Sorting: In-stock first, then price #}
                            {% set in_stock = filtered_sups|selectattr('qty', 'gt', 0)|sort(attribute='price') %}
                            {% set out_of_stock = filtered_sups|selectattr('qty', 'le', 0)|sort(attribute='price') %}

                            {% for s in in_stock + out_of_stock %}
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <td data-label="Supplier" style="padding: 6px 8px;">{{ s.supplier }}</td>
                                <td data-label="SKU"
                                    style="padding: 6px 8px; font-family: monospace; font-size: 0.9em;">
                                    {{ s.supplier_sku }}
                                    {% if s.product_name %}
                                    <div
                                        style="font-family: sans-serif; font-size: 0.85em; color: var(--text-muted); margin-top: 2px;">
                                        {{ s.product_name }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td data-label="Price" style="padding: 6px 8px; text-align: right; font-weight: bold;
                                    {% if item.our_price and s.price %}
                                        {% if s.price < item.our_price %}color: var(--success-color);
                                        {% elif s.price > item.our_price %}color: var(--danger-color);
                                        {% endif %}
                                    {% endif %}">
                                    {% if s.currency != 'RUB' %}
                                    <span
                                        style="font-size: 0.9em; opacity: 0.8; font-weight: normal; color: var(--text-color);">{{
                                        s.original_price }} {{ s.currency }}</span>
                                    <span style="margin: 0 4px; opacity: 0.5; color: var(--text-color);">‚Üí</span>
                                    {% endif %}
                                    {{ s.price }} <span style="font-size: 0.8em; opacity: 0.6;">‚ÇΩ</span>
                                </td>
                                <td data-label="Qty"
                                    style="padding: 6px 8px; text-align: right; color: {% if s.qty > 0 %}#4caf50{% else %}#f44336{% endif %};">
                                    {{ s.qty }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div id="history-{{ item.sku }}" style="margin-top: 15px; display: none;"></div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="pagination" style="display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px;">
    <!-- Pagination will be rendered here -->
</div>

<script src="{{ url_for('static', filename='js/table_filters.js') }}"></script>
<script>
    let searchTimeout = null;
    const searchInput = document.getElementById('searchInput');
    const resultsBody = document.getElementById('resultsBody');
    const paginationContainer = document.getElementById('pagination');

    // Default state matches server default
    let currentSort = { column: 'created_at', asc: false };
    let currentPage = 1;
    const limit = {{ limit }};

    function formatTs(ts) {
        if (!ts) return '-';
        const d = new Date(ts * 1000);
        const pad = (n) => n.toString().padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function parseFilterInput(val) {
        if (!val) return {};
        val = val.trim();

        let qty = null;
        let price = null;

        // Try to find quantity pattern (q>... or q:...)
        // Regex looks for 'q' followed optionally by operator, then numbers
        const qtyMatch = val.match(/q\s*([<>=!:]+)?\s*(\d+)/i);
        if (qtyMatch) {
            let op = qtyMatch[1] || '';
            if (op === ':') op = '='; // treat q:10 as q=10
            qty = (op + qtyMatch[2]).trim();

            // Remove the qty part from the string to get price
            val = val.replace(qtyMatch[0], '').trim();
        }

        if (val) {
            price = val;
        }

        const result = {};
        if (price) result.price = price;
        if (qty) result.qty = qty;

        return result;
    }

    function fetchData(page = 1) {
        currentPage = page;
        const q = searchInput.value.trim();
        const params = new URLSearchParams();
        params.append('q', q);
        params.append('limit', limit);
        params.append('page', currentPage);
        params.append('sort_by', currentSort.column);
        params.append('sort_asc', currentSort.asc);

        // Collect filters
        const fOur = document.getElementById('filter-our-price')?.value;
        const pOur = parseFilterInput(fOur);
        if (pOur.price) params.append('our_price', pOur.price);
        if (pOur.qty) params.append('our_qty', pOur.qty);

        const fMySklad = document.getElementById('filter-mysklad')?.value;
        const pMy = parseFilterInput(fMySklad);
        if (pMy.price) params.append('my_sklad_price', pMy.price);
        if (pMy.qty) params.append('my_sklad_qty', pMy.qty);

        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.replaceState({}, '', newUrl);

        // Show loading state
        paginationContainer.innerHTML = '<span style="opacity:0.5;">Loading...</span>';
        resultsBody.style.opacity = '0.5';

        fetch(`/api/search?${params.toString()}`)
            .then(r => r.json())
            .then(data => {
                resultsBody.style.opacity = '1';
                renderResults(data.items || []);
                renderPagination(data);
            });
    }

    function renderPagination(data) {
        if (!data.total_pages || data.total_pages <= 1) {
            paginationContainer.innerHTML = '';
            return;
        }

        let html = '';

        // Prev button
        if (data.page > 1) {
            html += `<button onclick="fetchData(${data.page - 1})" class="btn-page">‚ùÆ Prev</button>`;
        } else {
            html += `<button class="btn-page" disabled style="opacity:0.5; cursor:default;">‚ùÆ Prev</button>`;
        }

        // Info
        html += `<span style="margin: 0 15px; font-weight: bold;">Page ${data.page} of ${data.total_pages}</span>`;

        // Next button
        if (data.page < data.total_pages) {
            html += `<button onclick="fetchData(${data.page + 1})" class="btn-page">Next ‚ùØ</button>`;
        } else {
            html += `<button class="btn-page" disabled style="opacity:0.5; cursor:default;">Next ‚ùØ</button>`;
        }

        // Add some basic styles inline or use a class if defined
        html += `<style>
            .btn-page {
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                color: var(--text-color);
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                transition: background 0.2s;
            }
            .btn-page:hover:not(:disabled) {
                background: var(--hover-color);
                border-color: var(--accent-color);
            }
        </style>`;

        paginationContainer.innerHTML = html;
    }



    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => fetchData(1), 500);
    });

    ['filter-our-price', 'filter-mysklad'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => fetchData(1), 600);
        });
    });

    function toggleSortMenu() {
        document.getElementById("sortDropdown").classList.toggle("show");
    }

    // Close the dropdown if the user clicks outside of it
    window.onclick = function (event) {
        if (!event.target.matches('.dropdown span') && !event.target.matches('.dropdown span *')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    }

    function handleSort(column) {
        if (currentSort.column === column) {
            currentSort.asc = !currentSort.asc;
        } else {
            currentSort.column = column;
            currentSort.asc = false;
            // For prices, default to ASC usually
            if (['our_price', 'my_sklad_price', 'min_sup_supplier'].includes(column)) {
                currentSort.asc = true;
            }
        }
        updateSortIcons();
        fetchData(1);
    }

    // Alias for compatibility if needed, but handled in init
    function handleFilter() { fetchData(); }

    function updateSortIcons() {
        document.querySelectorAll('.sort-icon').forEach(el => el.textContent = '‚áÖ');
        if (currentSort.column) {
            const el = document.getElementById('sort-' + currentSort.column);
            if (el) el.textContent = currentSort.asc ? '‚ñ≤' : '‚ñº';
        }
    }

    function renderResults(items) {
        if (!items || items.length === 0) {
            resultsBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No results found</td></tr>';
            return;
        }

        let html = '';
        items.forEach(item => {
            const msPrice = item.my_sklad_price || 0;
            const msQty = item.my_sklad_qty || 0;
            const msDiff = (item.our_price && msPrice) ? Math.round((item.our_price - msPrice)) : 0;

            const updatedDate = new Date(item.updated_at * 1000);
            const now = new Date();
            const hoursDiff = (now - updatedDate) / (1000 * 60 * 60);
            const rowClass = hoursDiff > 24 ? 'outdated' : '';

            html += `
            <tr class="${rowClass}" style="cursor: pointer;" onclick="toggleDetails('${item.sku}')">
                <td data-label="Product">
                    <div style="font-weight: bold; color: var(--accent-color); font-size: 1.1em; margin-bottom: 4px;">${item.name || ''}</div>
                    <div style="font-size: 0.85em; opacity: 0.7;">
                        SKU: <a href="/?q=${item.sku}" style="color: inherit; text-decoration: underline;" onclick="event.stopPropagation()">${item.sku}</a> | 
                        Created: ${formatTs(item.created_at)} | 
                        Updated: ${formatTs(item.updated_at)}
                    </div>
                </td>
                <td style="text-align: right;">
                    <div class="price-val">${item.our_price} ‚ÇΩ</div>
                    <div class="qty-val" style="color: ${item.our_qty > 0 ? '#4caf50' : '#f44336'}">–∫–æ–ª-–≤–æ: ${item.our_qty}</div>
                </td>
                <td style="text-align: right;">
                    <div class="price-val">${msPrice} ‚ÇΩ</div>
                    <div class="qty-val" style="color: ${msQty > 0 ? '#4caf50' : '#f44336'}">–∫–æ–ª-–≤–æ: ${msQty}</div>
                    ${msDiff !== 0 ? `<div style="font-size:0.8em; color:${msDiff > 0 ? '#4caf50' : '#f44336'}">${msDiff > 0 ? '+' : ''}${msDiff}</div>` : ''}
                </td>
                <td style="text-align: right;">
                    <div class="price-val">${item.min_sup_price || 'N/A'} ${item.min_sup_price ? '‚ÇΩ' : ''}</div>
                    <div class="qty-val">${item.sup_stats || ''}</div>
                    <div class="supplier-name">${item.min_sup_supplier || ''}</div>
                </td>
                <td style="text-align: center;">
                    <button class="btn-action" style="background: transparent; border: 1px solid #888; color: #888; cursor: pointer; border-radius: 4px; padding: 4px 8px;">‚ñº</button>
                </td>
            </tr>
            <tr id="details-${item.sku}" class="details-row" style="display: none;">
                <td colspan="5" style="padding: 10px 20px; border-bottom: 2px solid var(--border-color); background: rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; opacity: 0.8;">–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</h4>
                        <button class="btn-action" onclick="showHistory('${item.sku}')"
                            style="background: var(--bg-card); border: 1px solid var(--accent-color); color: var(--accent-color); cursor: pointer; border-radius: 4px; padding: 6px 12px; font-weight: bold;">üìä –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ü–µ–Ω</button>
                    </div>
                    <table class="suppliers-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <th style="text-align: left; padding: 8px;">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                <th style="text-align: left; padding: 8px;">–ê—Ä—Ç–∏–∫—É–ª</th>
                                <th style="text-align: right; padding: 8px;">–¶–µ–Ω–∞</th>
                                <th style="text-align: right; padding: 8px;">–∫–æ–ª-–≤–æ</th>
                            </tr>
                        </thead>
                        <tbody>${renderSuppliers(item)}</tbody>
                    </table>
                    <div id="history-${item.sku}" style="margin-top: 15px; display: none;"></div>
                </td>
            </tr>`;
        });
        resultsBody.innerHTML = html;
    }

    function renderSuppliers(item) {
        try {
            let suppliers = JSON.parse(item.suppliers_json || '[]');
            suppliers = suppliers.filter(s => s.supplier.toLowerCase() !== '–º–æ–π —Å–∫–ª–∞–¥');
            suppliers.sort((a, b) => {
                const aStock = a.qty > 0 ? 1 : 0;
                const bStock = b.qty > 0 ? 1 : 0;
                if (aStock !== bStock) return bStock - aStock;
                return a.price - b.price;
            });

            return suppliers.map(s => {
                let priceStyle = 'padding: 6px 8px; text-align: right; font-weight: bold;';
                if (item.our_price && s.price) {
                    if (s.price < item.our_price) priceStyle += ' color: var(--success-color);';
                    else if (s.price > item.our_price) priceStyle += ' color: var(--danger-color);';
                }

                const priceDisplay = s.currency !== 'RUB'
                    ? `<span style="font-size: 0.9em; opacity: 0.8; font-weight: normal; color: var(--text-color);">${s.original_price} ${s.currency}</span> <span style="margin: 0 4px; opacity: 0.5; color: var(--text-color);">‚Üí</span> ${s.price} <span style="font-size: 0.8em; opacity: 0.6;">‚ÇΩ</span>`
                    : `${s.price} <span style="font-size: 0.8em; opacity: 0.6;">‚ÇΩ</span>`;

                return `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 6px 8px;">${s.supplier}</td>
                    <td style="padding: 6px 8px; font-family: monospace; font-size: 0.9em;">
                        ${s.supplier_sku || ''}
                        ${s.product_name ? `<div style="font-family: sans-serif; font-size: 0.85em; color: var(--text-muted); margin-top: 2px;">${s.product_name}</div>` : ''}
                    </td>
                    <td style="${priceStyle}">${priceDisplay}</td>
                    <td style="padding: 6px 8px; text-align: right; color: ${s.qty > 0 ? '#4caf50' : '#f44336'};">${s.qty}</td>
                </tr>`;
            }).join('');
        } catch (e) { return ''; }
    }

    function toggleDetails(sku) {
        const row = document.getElementById('details-' + sku);
        if (row) row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
    }

    function showHistory(sku, days = 7) {
        const container = document.getElementById('history-' + sku);
        const detailsRow = document.getElementById('details-' + sku);

        if (container.style.display === 'block' && arguments.length === 1) {
            container.style.display = 'none';
            return;
        }

        detailsRow.style.display = 'table-row';
        container.style.display = 'block';
        container.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.7;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';

        fetch(`/ui/history?sku=${encodeURIComponent(sku)}&days=${days}`)
            .then(r => r.text())
            .then(html => {
                const range = document.createRange();
                const fragment = range.createContextualFragment(html);
                container.innerHTML = '';
                container.appendChild(fragment);
            })
            .catch(err => {
                container.innerHTML = '<div style="color: #f44336; padding: 10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err + '</div>';
            });
    }

    function triggerReload(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        const btn = document.getElementById('reloadBtn');
        const status = document.getElementById('reloadStatus');

        if (!confirm("–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ú–æ–π–°–∫–ª–∞–¥ –∏ –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.")) return;

        btn.disabled = true;
        btn.style.opacity = "0.5";
        status.innerText = "Processing...";
        status.style.color = "var(--accent-color)";

        fetch('/api/reload')
            .then(r => r.json())
            .then(d => {
                btn.disabled = false;
                btn.style.opacity = "1";
                if (d.ok) {
                    status.innerText = d.message || "Done!";
                    status.style.color = "#4caf50";
                    setTimeout(() => { status.innerText = ""; }, 5000);
                } else {
                    status.innerText = "Error: " + d.error;
                    status.style.color = "#f44336";
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.style.opacity = "1";
                status.innerText = "Network error";
                status.style.color = "#f44336";
            });
    }

    function showLogs() {
        const modal = document.getElementById('logModal');
        const content = document.getElementById('logContent');
        modal.style.display = 'block';
        content.innerText = 'Loading logs...';

        fetch('/api/logs')
            .then(r => r.json())
            .then(d => {
                if (d.ok) {
                    content.innerText = d.logs || 'Log file is empty.';
                    content.scrollTop = content.scrollHeight;
                } else {
                    content.innerText = 'Error loading logs: ' + d.error;
                }
            })
            .catch(err => {
                content.innerText = 'Network error: ' + err;
            });
    }

    function closeLogs() {
        document.getElementById('logModal').style.display = 'none';
    }

    // Initial load
    fetchData(1);
</script>
{% endblock %}