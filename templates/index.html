{% extends "base.html" %}

{% block content %}
<div class="status-bar">
    <span>DB Path: {{ status.db_path }}</span>
    <span>Items: {{ status.items_db }}</span>
    <span>Last Run: {{ status.worker_last_run_ts | format_ts }}</span>
    {% if status.ok %}
    <span style="color: var(--success-color)">● System OK</span>
    {% else %}
    <span style="color: var(--danger-color)">● {{ status.error }}</span>
    {% endif %}
    <div class="stats">
        DB: <b>priceweb.db</b> | Status: <b style="color: #4caf50;">OK</b> | Items: <b>{{ status.total_items }}</b>
        <button id="reloadBtn" onclick="triggerReload(event)"
            style="margin-left: 10px; cursor: pointer; background: var(--bg-card); color: var(--accent-color); border: 1px solid var(--accent-color); border-radius: 4px; padding: 2px 8px; font-size: 11px;">Reload
            Data</button>
        <span id="reloadStatus" style="font-size: 11px; margin-left: 5px;"></span>
    </div>
</div>

<form id="searchForm" class="toolbar" method="get" action="/">
    <input type="text" id="searchInput" name="q" placeholder="Live Search SKU or Name..." value="{{ q }}" size="40"
        autocomplete="off">
    <select name="limit" onchange="this.form.submit()">
        <option value="20" {% if limit==20 %}selected{% endif %}>20 results</option>
        <option value="50" {% if limit==50 %}selected{% endif %}>50 results</option>
        <option value="100" {% if limit==100 %}selected{% endif %}>100 results</option>
    </select>
    <button type="submit" class="primary">Search</button>
</form>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th style="width: 50%;"></th>
                <th style="text-align: right;">Наша цена</th>
                <th style="text-align: right;">Мой Склад</th>
                <th style="text-align: right;">Поставщик</th>
                <th style="text-align: center;">История</th>
            </tr>
        </thead>
        <tbody id="resultsBody">
            {% for item in items %}
            <tr class="product-row" style="background: rgba(255,255,255,0.05);">
                <td>
                    <div style="font-weight: bold; color: var(--accent-color); font-size: 1.1em; margin-bottom: 4px;">{{
                        item.name }}</div>
                    <div style="font-size: 0.85em; opacity: 0.7;">SKU: {{ item.sku }} | Updated: {{
                        item.updated_at|format_ts }}</div>
                </td>
                <td style="text-align: right; vertical-align: middle;">
                    <div style="font-size: 1.2em; font-weight: bold;">{{ item.our_price }}</div>
                    <div style="font-size: 0.8em; opacity: 0.6;">кол-во: {{ item.our_qty }}</div>
                </td>
                <td style="text-align: right; vertical-align: middle;">
                    <div
                        style="font-weight: bold; color: {% if item.my_sklad_qty > 0 %}#4caf50{% else %}#888{% endif %};">
                        {{ item.my_sklad_price }}
                    </div>
                    <div style="font-size: 0.8em; opacity: 0.6;">кол-во: {{ item.my_sklad_qty }}</div>
                </td>
                <td style="text-align: right; vertical-align: middle;">
                    <div style="font-weight: bold;">{{ item.min_sup_price or 'N/A' }}</div>
                    <div style="font-size: 0.8em; opacity: 0.7;">{{ item.min_sup_supplier or '-' }}</div>
                </td>
                <td style="text-align: center; vertical-align: middle;">
                    <button class="btn-action" onclick="showHistory('{{ item.sku }}')"
                        style="background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); cursor: pointer; border-radius: 4px; padding: 4px 8px;">История</button>
                    <button class="btn-action" onclick="toggleDetails('{{ item.sku }}')"
                        style="margin-left: 5px; background: transparent; border: 1px solid #888; color: #888; cursor: pointer; border-radius: 4px; padding: 4px 8px;">▼</button>
                </td>
            </tr>
            <tr id="details-{{ item.sku }}" class="details-row" style="display: none;">
                <td colspan="5"
                    style="padding: 10px 20px; border-bottom: 2px solid var(--border-color); background: rgba(0,0,0,0.1);">
                    <table class="suppliers-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <th style="text-align: left; padding: 8px;">Поставщик</th>
                                <th style="text-align: left; padding: 8px;">Артикул</th>
                                <th style="text-align: right; padding: 8px;">Цена</th>
                                <th style="text-align: right; padding: 8px;">кол-во</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set suppliers = item.suppliers_json|fromjson %}
                            {# Sort by price ascending, filter out My Sklad #}
                            {% for s in suppliers|sort(attribute='price') %}
                            {% if s.supplier.lower() != 'мой склад' %}
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <td style="padding: 6px 8px;">{{ s.supplier }}</td>
                                <td style="padding: 6px 8px; font-family: monospace; font-size: 0.9em;">{{
                                    s.supplier_sku }}</td>
                                <td style="padding: 6px 8px; text-align: right; font-weight: bold;">{{ s.price }} <span
                                        style="font-size: 0.8em; opacity: 0.6;">{{ s.currency }}</span></td>
                                <td
                                    style="padding: 6px 8px; text-align: right; color: {% if s.qty > 0 %}#4caf50{% else %}#f44336{% endif %};">
                                    {{ s.qty }}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    <div id="history-{{ item.sku }}" style="margin-top: 15px;"></div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    let searchTimeout = null;
    const searchInput = document.getElementById('searchInput');
    const resultsBody = document.getElementById('resultsBody');

    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const q = searchInput.value.trim();
        if (!q) {
            resultsBody.innerHTML = '';
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`/api/search?q=${encodeURIComponent(q)}&limit={{ limit }}`)
                .then(r => r.json())
                .then(data => {
                    renderResults(data.items);
                });
        }, 500);
    });

    function renderResults(items) {
        if (!items || items.length === 0) {
            resultsBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No results found</td></tr>';
            return;
        }

        let html = '';
        items.forEach(item => {
            let suppliers = JSON.parse(item.suppliers_json);
            // Sort suppliers by price property
            suppliers.sort((a, b) => a.price - b.price);

            let suppliersHtml = '';
            suppliers.forEach(s => {
                if (s.supplier.toLowerCase() !== 'мой склад') {
                    suppliersHtml += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 6px 8px;">${s.supplier}</td>
                            <td style="padding: 6px 8px; font-family: monospace; font-size: 0.9em;">${s.supplier_sku || ''}</td>
                            <td style="padding: 6px 8px; text-align: right; font-weight: bold;">${s.price} <span style="font-size: 0.8em; opacity: 0.6;">${s.currency || 'RUB'}</span></td>
                            <td style="padding: 6px 8px; text-align: right; color: ${s.qty > 0 ? '#4caf50' : '#f44336'};">
                                ${s.qty}
                            </td>
                        </tr>`;
                }
            });

            html += `
                <tr class="product-row" style="background: rgba(255,255,255,0.05);">
                    <td>
                        <div style="font-weight: bold; color: var(--accent-color); font-size: 1.1em; margin-bottom: 4px;">${item.name}</div>
                        <div style="font-size: 0.85em; opacity: 0.7;">SKU: ${item.sku}</div>
                    </td>
                    <td style="text-align: right; vertical-align: middle;">
                        <div style="font-size: 1.2em; font-weight: bold;">${item.our_price}</div>
                        <div style="font-size: 0.8em; opacity: 0.6;">кол-во: ${item.our_qty}</div>
                    </td>
                    <td style="text-align: right; vertical-align: middle;">
                        <div style="font-weight: bold; color: ${item.my_sklad_qty > 0 ? '#4caf50' : '#888'};">
                            ${item.my_sklad_price}
                        </div>
                        <div style="font-size: 0.8em; opacity: 0.6;">кол-во: ${item.my_sklad_qty}</div>
                    </td>
                    <td style="text-align: right; vertical-align: middle;">
                        <div style="font-weight: bold;">${item.min_sup_price || 'N/A'}</div>
                        <div style="font-size: 0.8em; opacity: 0.7;">${item.min_sup_supplier || '-'}</div>
                    </td>
                    <td style="text-align: center; vertical-align: middle;">
                        <button class="btn-action" onclick="showHistory('${item.sku}')" style="background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); cursor: pointer; border-radius: 4px; padding: 4px 8px;">История</button>
                        <button class="btn-action" onclick="toggleDetails('${item.sku}')" style="margin-left: 5px; background: transparent; border: 1px solid #888; color: #888; cursor: pointer; border-radius: 4px; padding: 4px 8px;">▼</button>
                    </td>
                </tr>
                <tr id="details-${item.sku}" class="details-row" style="display: none;">
                    <td colspan="5" style="padding: 10px 20px; border-bottom: 2px solid var(--border-color); background: rgba(0,0,0,0.1);">
                        <table class="suppliers-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <th style="text-align: left; padding: 8px;">Поставщик</th>
                                    <th style="text-align: left; padding: 8px;">Артикул</th>
                                    <th style="text-align: right; padding: 8px;">Цена</th>
                                    <th style="text-align: right; padding: 8px;">кол-во</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${suppliersHtml}
                            </tbody>
                        </table>
                        <div id="history-${item.sku}" style="margin-top: 15px;"></div>
                    </td>
                </tr>`;
        });
        resultsBody.innerHTML = html;
    }

    function toggleDetails(sku) {
        const row = document.getElementById('details-' + sku);
        row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
    }

    function showHistory(sku) {
        const container = document.getElementById('history-' + sku);
        const detailsRow = document.getElementById('details-' + sku);
        detailsRow.style.display = 'table-row';

        container.innerHTML = 'Loading history...';
        fetch('/ui/history?sku=' + encodeURIComponent(sku))
            .then(r => r.text())
            .then(html => {
                container.innerHTML = html;
            });
    }

    function triggerReload(e) {
        if (e) e.preventDefault();
        const btn = document.getElementById('reloadBtn');
        const status = document.getElementById('reloadStatus');

        if (!confirm("Start background worker reload?")) return;

        btn.disabled = true;
        btn.style.opacity = "0.5";
        status.innerText = "Processing...";
        status.style.color = "var(--accent-color)";

        fetch('/api/reload')
            .then(r => r.json())
            .then(d => {
                btn.disabled = false;
                btn.style.opacity = "1";
                if (d.ok) {
                    status.innerText = "Done!";
                    status.style.color = "#4caf50";
                    setTimeout(() => { status.innerText = ""; }, 3000);
                } else {
                    status.innerText = "Error: " + d.error;
                    status.style.color = "#f44336";
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.style.opacity = "1";
                status.innerText = "Network error";
                status.style.color = "#f44336";
            });
    }
</script>
{% endblock %}