{% extends "base.html" %}

{% block content %}
<div class="status-bar">
    <div class="stats">
        <span title="{{ status.db_path }}">DB: <b>{{ status.db_path.split('/')[-1] }}</b></span>
        <span>Items: <b>{{ status.items_db }}</b></span>
        <span>Last Run: <b>{{ status.worker_last_run_ts | format_ts }}</b></span>
        <span class="status-indicator"
            style="color: {% if status.ok %}var(--success-color){% else %}var(--danger-color){% endif %};">
            ‚óè {% if status.ok %}System OK{% else %}{{ status.error }}{% endif %}
        </span>
        <span style="opacity: 0.5; font-size: 0.85em; margin-left: auto;">v{{ status.version }}</span>
        <div class="actions">
            <button id="reloadBtn" type="button" onclick="triggerReload(event)" class="btn-reload">Reload Data</button>
            <button type="button" onclick="showLogs()" class="btn-logs">View Logs</button>
            <span id="reloadStatus" class="status-text"></span>
        </div>
    </div>
</div>

<!-- Log Modal -->
<div id="logModal" class="modal"
    style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter: blur(4px);">
    <div
        style="background:var(--bg-card); margin: 5% auto; padding: 20px; border: 1px solid var(--border-color); width: 80%; max-width: 900px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">Worker Logs (Last 100 lines)</h3>
            <span onclick="closeLogs()" style="cursor:pointer; font-size:24px; opacity:0.6;">&times;</span>
        </div>
        <pre id="logContent"
            style="background:#000; color:#0f0; padding:15px; border-radius:4px; max-height:500px; overflow-y:auto; font-family:monospace; font-size:12px; white-space:pre-wrap;"></pre>
        <div style="text-align:right; margin-top:15px;">
            <button onclick="closeLogs()" class="primary">Close</button>
        </div>
    </div>
</div>

<form id="searchForm" class="toolbar" method="get" action="/">
    <input type="text" id="searchInput" name="q" placeholder="Live Search SKU or Name..." value="{{ q }}" size="40"
        autocomplete="off">
    <select name="limit" onchange="this.form.submit()">
        <option value="20" {% if limit==20 %}selected{% endif %}>20 results</option>
        <option value="50" {% if limit==50 %}selected{% endif %}>50 results</option>
        <option value="100" {% if limit==100 %}selected{% endif %}>100 results</option>
    </select>
    <button type="submit" class="primary">Search</button>
</form>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th style="width: 40%; cursor: pointer;" onclick="handleSort('product')">
                    Product <span id="sort-product" class="sort-icon">‚áÖ</span>
                </th>
                <th style="text-align: right; cursor: pointer;" onclick="handleSort('our_price')">
                    –ù–∞—à–∞ —Ü–µ–Ω–∞ <span id="sort-our_price" class="sort-icon">‚áÖ</span>
                </th>
                <th style="text-align: right; cursor: pointer;" onclick="handleSort('mysklad')">
                    –ú–æ–π –°–∫–ª–∞–¥ <span id="sort-mysklad" class="sort-icon">‚áÖ</span>
                </th>
                <th style="text-align: right; cursor: pointer;" onclick="handleSort('supplier')">
                    –ü–æ—Å—Ç–∞–≤—â–∏–∫ <span id="sort-supplier" class="sort-icon">‚áÖ</span>
                </th>
                <th style="text-align: center;"></th>
            </tr>
            <tr class="filter-row">
                <th><input id="filter-product" oninput="handleFilter()" placeholder="Filter Name/SKU..."
                        style="width:100%; box-sizing:border-box;"></th>
                <th><input id="filter-our-price" oninput="handleFilter()" placeholder="Price..."
                        style="width:100%; box-sizing:border-box; text-align:right;"></th>
                <th><input id="filter-mysklad" oninput="handleFilter()" placeholder="Price..."
                        style="width:100%; box-sizing:border-box; text-align:right;"></th>
                <th><input id="filter-supplier" oninput="handleFilter()" placeholder="Supplier..."
                        style="width:100%; box-sizing:border-box; text-align:right;"></th>
                <th></th>
            </tr>
        </thead>
        <tbody id="resultsBody">
            {% for item in items %}
            <tr class="product-row" style="cursor: pointer;" onclick="toggleDetails('{{ item.sku }}')">
                <td data-label="Product">
                    <div style="font-weight: bold; color: var(--accent-color); font-size: 1.1em; margin-bottom: 4px;">{{
                        item.name }}</div>
                    <div style="font-size: 0.85em; opacity: 0.7;">SKU: {{ item.sku }} | Created: {{
                        item.created_at|format_ts }} | Updated: {{
                        item.updated_at|format_ts }}</div>
                </td>
                <td data-label="–ù–∞—à–∞ —Ü–µ–Ω–∞" style="text-align: right; vertical-align: middle;">
                    <div style="font-size: 1.2em; font-weight: bold;">{{ item.our_price }} ‚ÇΩ</div>
                    <div style="font-size: 0.8em; opacity: 0.6;">–∫–æ–ª-–≤–æ: {{ item.our_qty }}</div>
                </td>
                <td data-label="–ú–æ–π –°–∫–ª–∞–¥" style="text-align: right; vertical-align: middle;">
                    <div
                        style="font-weight: bold; color: {% if item.my_sklad_qty > 0 %}#4caf50{% else %}#888{% endif %};">
                        {{ item.my_sklad_price }} ‚ÇΩ
                    </div>
                    <div style="font-size: 0.8em; opacity: 0.6;">–∫–æ–ª-–≤–æ: {{ item.my_sklad_qty }}</div>
                </td>
                <td data-label="–ü–æ—Å—Ç–∞–≤—â–∏–∫" style="text-align: right; vertical-align: middle;">
                    <div style="font-weight: bold;">{{ item.min_sup_price if item.min_sup_price else 'N/A' }}{% if
                        item.min_sup_price %} ‚ÇΩ{% endif %}</div>
                    <div style="font-size: 0.8em; opacity: 0.7;">{{ item.min_sup_supplier or '-' }} {{ item.sup_stats }}
                    </div>
                </td>
                <td data-label="" style="text-align: center; vertical-align: middle;">
                    <button class="btn-action"
                        style="background: transparent; border: 1px solid #888; color: #888; cursor: pointer; border-radius: 4px; padding: 4px 8px;">‚ñº</button>
                </td>
            </tr>
            <tr id="details-{{ item.sku }}" class="details-row" style="display: none;">
                <td colspan="5"
                    style="padding: 10px 20px; border-bottom: 2px solid var(--border-color); background: rgba(0,0,0,0.1);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; opacity: 0.8;">–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</h4>
                        <button class="btn-action" onclick="showHistory('{{ item.sku }}')"
                            style="background: var(--bg-card); border: 1px solid var(--accent-color); color: var(--accent-color); cursor: pointer; border-radius: 4px; padding: 6px 12px; font-weight: bold;">üìä
                            –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ü–µ–Ω</button>
                    </div>
                    <table class="suppliers-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <th style="text-align: left; padding: 8px;">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                <th style="text-align: left; padding: 8px;">–ê—Ä—Ç–∏–∫—É–ª</th>
                                <th style="text-align: right; padding: 8px;">–¶–µ–Ω–∞</th>
                                <th style="text-align: right; padding: 8px;">–∫–æ–ª-–≤–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set raw_suppliers = item.suppliers_json|fromjson %}
                            {# Filter out My Sklad #}
                            {% set filtered_sups = [] %}
                            {% for s in raw_suppliers %}
                            {% if s.supplier.lower() != '–º–æ–π —Å–∫–ª–∞–¥' %}
                            {% set _ = filtered_sups.append(s) %}
                            {% endif %}
                            {% endfor %}

                            {# Sorting: In-stock first, then price #}
                            {% set in_stock = filtered_sups|selectattr('qty', 'gt', 0)|sort(attribute='price') %}
                            {% set out_of_stock = filtered_sups|selectattr('qty', 'le', 0)|sort(attribute='price') %}

                            {% for s in in_stock + out_of_stock %}
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <td data-label="Supplier" style="padding: 6px 8px;">{{ s.supplier }}</td>
                                <td data-label="SKU"
                                    style="padding: 6px 8px; font-family: monospace; font-size: 0.9em;">{{
                                    s.supplier_sku }}</td>
                                <td data-label="Price" style="padding: 6px 8px; text-align: right; font-weight: bold;">
                                    {% if s.currency != 'RUB' %}
                                    <span style="font-size: 0.9em; opacity: 0.8; font-weight: normal;">{{
                                        s.original_price }} {{ s.currency }}</span>
                                    <span style="margin: 0 4px; opacity: 0.5;">‚Üí</span>
                                    {% endif %}
                                    {{ s.price }} <span style="font-size: 0.8em; opacity: 0.6;">‚ÇΩ</span>
                                </td>
                                <td data-label="Qty"
                                    style="padding: 6px 8px; text-align: right; color: {% if s.qty > 0 %}#4caf50{% else %}#f44336{% endif %};">
                                    {{ s.qty }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div id="history-{{ item.sku }}" style="margin-top: 15px; display: none;"></div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    let searchTimeout = null;
    const searchInput = document.getElementById('searchInput');
    const resultsBody = document.getElementById('resultsBody');

    function formatTs(ts) {
        if (!ts) return '-';
        const d = new Date(ts * 1000);
        const pad = (n) => n.toString().padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const q = searchInput.value.trim();
        if (!q) {
            resultsBody.innerHTML = '';
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`/api/search?q=${encodeURIComponent(q)}&limit={{ limit }}`)
                .then(r => r.json())
                .then(data => {
                    currentData = data.items || [];
                    renderResults(currentData);
                });
        }, 500);
    });

    function renderResults(items) {
        if (!items || items.length === 0) {
            resultsBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No results found</td></tr>';
            return;
        }

        // --- Filtering Logic ---
        const filters = {
            product: document.getElementById('filter-product')?.value.toLowerCase() || '',
            our_price: document.getElementById('filter-our-price')?.value || '',
            mysklad: document.getElementById('filter-mysklad')?.value || '',
            supplier: document.getElementById('filter-supplier')?.value.toLowerCase() || ''
        };

        let filteredItems = items.filter(item => {
            if (filters.product && !item.name.toLowerCase().includes(filters.product) && !item.sku.toLowerCase().includes(filters.product)) return false;
            // Simple logic for price filters: > value. Can be improved.
            // For now, let's treat price inputs as "matches text" for simplicity or numbers?
            // User requested "filtering", usually text match or ranges. simple includes for now.
            if (filters.our_price && !String(item.our_price).includes(filters.our_price)) return false;
            if (filters.mysklad && !String(item.my_sklad_price).includes(filters.mysklad)) return false;
            if (filters.supplier && !(item.min_sup_supplier || '').toLowerCase().includes(filters.supplier)) return false;
            return true;
        });

        // --- Sorting Logic ---
        if (currentSort.column) {
            filteredItems.sort((a, b) => {
                let valA = getSortValue(a, currentSort.column);
                let valB = getSortValue(b, currentSort.column);

                if (typeof valA === 'number' && typeof valB === 'number') {
                    return currentSort.asc ? valA - valB : valB - valA;
                }
                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();
                if (valA < valB) return currentSort.asc ? -1 : 1;
                if (valA > valB) return currentSort.asc ? 1 : -1;
                return 0;
            });
        }

        if (filteredItems.length === 0) {
            resultsBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No results matching filters</td></tr>';
            return;
        }

        let html = '';
        filteredItems.forEach(item => {
            let suppliers = JSON.parse(item.suppliers_json || '[]');

            // Filter My Sklad
            suppliers = suppliers.filter(s => s.supplier.toLowerCase() !== '–º–æ–π —Å–∫–ª–∞–¥');

            // Complex Sorting: Qty > 0 first, then Price
            suppliers.sort((a, b) => {
                const aStock = a.qty > 0 ? 1 : 0;
                const bStock = b.qty > 0 ? 1 : 0;
                if (aStock !== bStock) return bStock - aStock; // Descending stock status
                return a.price - b.price; // Ascending price
            });

            let suppliersHtml = '';
            suppliers.forEach(s => {
                const priceDisplay = s.currency !== 'RUB'
                    ? `<span style="font-size: 0.9em; opacity: 0.8; font-weight: normal;">${s.original_price} ${s.currency}</span> <span style="margin: 0 4px; opacity: 0.5;">‚Üí</span> ${s.price} <span style="font-size: 0.8em; opacity: 0.6;">‚ÇΩ</span>`
                    : `${s.price} <span style="font-size: 0.8em; opacity: 0.6;">‚ÇΩ</span>`;

                suppliersHtml += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td data-label="Supplier" style="padding: 6px 8px;">${s.supplier}</td>
                        <td data-label="SKU" style="padding: 6px 8px; font-family: monospace; font-size: 0.9em;">${s.supplier_sku || ''}</td>
                        <td data-label="Price" style="padding: 6px 8px; text-align: right; font-weight: bold;">${priceDisplay}</td>
                        <td data-label="Qty" style="padding: 6px 8px; text-align: right; color: ${s.qty > 0 ? '#4caf50' : '#f44336'};">
                            ${s.qty}
                        </td>
                    </tr>`;
            });

            html += `
                <tr class="product-row" style="cursor: pointer;" onclick="toggleDetails('${item.sku}')">
                    <td data-label="Product">
                        <div style="font-weight: bold; color: var(--accent-color); font-size: 1.1em; margin-bottom: 4px;">${item.name}</div>
                        <div style="font-size: 0.85em; opacity: 0.7;">SKU: ${item.sku} | Created: ${formatTs(item.created_at)} | Updated: ${formatTs(item.updated_at)}</div>
                    </td>
                    <td data-label="–ù–∞—à–∞ —Ü–µ–Ω–∞" style="text-align: right; vertical-align: middle;">
                        <div style="font-size: 1.2em; font-weight: bold;">${item.our_price} ‚ÇΩ</div>
                        <div style="font-size: 0.8em; opacity: 0.6;">–∫–æ–ª-–≤–æ: ${item.our_qty}</div>
                    </td>
                    <td data-label="–ú–æ–π –°–∫–ª–∞–¥" style="text-align: right; vertical-align: middle;">
                        <div style="font-weight: bold; color: ${item.my_sklad_qty > 0 ? '#4caf50' : '#888'};">
                            ${item.my_sklad_price} ‚ÇΩ
                        </div>
                        <div style="font-size: 0.8em; opacity: 0.6;">–∫–æ–ª-–≤–æ: ${item.my_sklad_qty}</div>
                    </td>
                    <td data-label="–ü–æ—Å—Ç–∞–≤—â–∏–∫" style="text-align: right; vertical-align: middle;">
                        <div style="font-weight: bold;">${item.min_sup_price ? item.min_sup_price + ' ‚ÇΩ' : 'N/A'}</div>
                        <div style="font-size: 0.8em; opacity: 0.7;">${item.min_sup_supplier || '-'} ${item.sup_stats || ''}</div>
                    </td>
                    <td data-label="" style="text-align: center; vertical-align: middle;">
                        <button class="btn-action" style="background: transparent; border: 1px solid #888; color: #888; cursor: pointer; border-radius: 4px; padding: 4px 8px;">‚ñº</button>
                    </td>
                </tr>
                <tr id="details-${item.sku}" class="details-row" style="display: none;">
                    <td colspan="5" style="padding: 10px 20px; border-bottom: 2px solid var(--border-color); background: rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; opacity: 0.8;">–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</h4>
                            <button class="btn-action" onclick="showHistory('${item.sku}')"
                                style="background: var(--bg-card); border: 1px solid var(--accent-color); color: var(--accent-color); cursor: pointer; border-radius: 4px; padding: 6px 12px; font-weight: bold;">üìä –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ü–µ–Ω</button>
                        </div>
                        <table class="suppliers-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <th style="text-align: left; padding: 8px;">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                    <th style="text-align: left; padding: 8px;">–ê—Ä—Ç–∏–∫—É–ª</th>
                                    <th style="text-align: right; padding: 8px;">–¶–µ–Ω–∞</th>
                                    <th style="text-align: right; padding: 8px;">–∫–æ–ª-–≤–æ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${suppliersHtml}
                            </tbody>
                        </table>
                        <div id="history-${item.sku}" style="margin-top: 15px; display: none;"></div>
                    </td>
                </tr>`;
        });
        resultsBody.innerHTML = html;
    }

    // Sorting State
    let currentSort = { column: null, asc: true };
    let currentData = []; // Store current set of items

    function getSortValue(item, column) {
        switch (column) {
            case 'product': return item.name;
            case 'our_price': return item.our_price;
            case 'mysklad': return item.my_sklad_price;
            case 'supplier': return item.min_sup_price || 999999999;
            default: return '';
        }
    }

    function handleSort(column) {
        if (currentSort.column === column) {
            currentSort.asc = !currentSort.asc;
        } else {
            currentSort.column = column;
            currentSort.asc = true;
        }
        updateSortIcons();
        renderResults(currentData); // Re-render with sort
    }

    function updateSortIcons() {
        document.querySelectorAll('.sort-icon').forEach(el => el.textContent = '‚áÖ');
        if (currentSort.column) {
            const el = document.getElementById('sort-' + currentSort.column);
            if (el) el.textContent = currentSort.asc ? '‚ñ≤' : '‚ñº';
        }
    }

    function handleFilter() {
        renderResults(currentData);
    }


    function toggleDetails(sku) {
        const row = document.getElementById('details-' + sku);
        row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
    }

    function showHistory(sku, days = 7) {
        const container = document.getElementById('history-' + sku);
        const detailsRow = document.getElementById('details-' + sku);

        // If simple toggle off
        if (container.style.display === 'block' && arguments.length === 1) {
            container.style.display = 'none';
            return;
        }

        detailsRow.style.display = 'table-row';
        container.style.display = 'block';
        container.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.7;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';

        fetch(`/ui/history?sku=${encodeURIComponent(sku)}&days=${days}`)
            .then(r => r.text())
            .then(html => {
                const range = document.createRange();
                const fragment = range.createContextualFragment(html);
                container.innerHTML = '';
                container.appendChild(fragment);
            })
            .catch(err => {
                container.innerHTML = '<div style="color: #f44336; padding: 10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err + '</div>';
            });
    }

    function triggerReload(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        const btn = document.getElementById('reloadBtn');
        const status = document.getElementById('reloadStatus');

        if (!confirm("–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ú–æ–π–°–∫–ª–∞–¥ –∏ –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.")) return;

        btn.disabled = true;
        btn.style.opacity = "0.5";
        status.innerText = "Processing...";
        status.style.color = "var(--accent-color)";

        fetch('/api/reload')
            .then(r => r.json())
            .then(d => {
                btn.disabled = false;
                btn.style.opacity = "1";
                if (d.ok) {
                    status.innerText = d.message || "Done!";
                    status.style.color = "#4caf50";
                    setTimeout(() => { status.innerText = ""; }, 5000);
                } else {
                    status.innerText = "Error: " + d.error;
                    status.style.color = "#f44336";
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.style.opacity = "1";
                status.innerText = "Network error";
                status.style.color = "#f44336";
            });
    }

    function showLogs() {
        const modal = document.getElementById('logModal');
        const content = document.getElementById('logContent');
        modal.style.display = 'block';
        content.innerText = 'Loading logs...';

        fetch('/api/logs')
            .then(r => r.json())
            .then(d => {
                if (d.ok) {
                    content.innerText = d.logs || 'Log file is empty.';
                    // Scroll to bottom
                    content.scrollTop = content.scrollHeight;
                } else {
                    content.innerText = 'Error loading logs: ' + d.error;
                }
            })
            .catch(err => {
                content.innerText = 'Network error: ' + err;
            });
    }

    function closeLogs() {
        document.getElementById('logModal').style.display = 'none';
    }
</script>
{% endblock %}