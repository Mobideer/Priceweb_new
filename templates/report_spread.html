{% extends "base.html" %}

{% block title %}Report: Spread - PriceWeb New{% endblock %}

{% block content %}
<h2>Report: Price Spread</h2>
<div style="color:#8b949e; margin-bottom:10px;">
    Shows items where (Max Price - Min Price) / Min Price >= Threshold %
</div>

<form class="toolbar" method="get">
    <div>
        <label>Threshold %</label>
        <input name="threshold" value="{{ threshold }}">
    </div>
    <div>
        <label>Per Page</label>
        <input name="limit" value="{{ limit }}">
    </div>
    <div>
        <label>Max Price</label>
        <input name="max_price" value="{{ max_price }}">
    </div>
    <div>
        <label>In Stock Only</label>
        <select name="in_stock_only">
            <option value="1" {% if in_stock_only==1 %}selected{% endif %}>Yes</option>
            <option value="0" {% if in_stock_only==0 %}selected{% endif %}>No</option>
        </select>
    </div>

    <div style="flex: 1 1 100%;">
        <details class="supbox" {% if exclude_list %}open{% endif %}
            style="border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; background: var(--header-bg);">
            <summary style="cursor: pointer; font-size: 13px;">
                Exclude Suppliers ({{ exclude_list|length }}) ‚Äî click to toggle
            </summary>
            <div style="margin-top: 10px;">
                <input id="supSearch" type="text" placeholder="Filter suppliers..."
                    style="width: 100%; box-sizing: border-box; margin-bottom: 10px;">
                <div id="supGrid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
                    {% for s in suppliers_all %}
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;"
                        data-supplier="{{ s|lower }}">
                        <input type="checkbox" name="exclude" value="{{ s }}" {% if s.lower() in exclude_set %}checked{%
                            endif %}>
                        <span>{{ s }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </details>
    </div>

    <button type="submit" class="primary">Update</button>
    <div class="total-summary">
        Total matches: <b>{{ total_count }}</b> products (Page {{ page }} of {{ total_pages }})
    </div>

    <table>
        <thead>
            <tr>
                <th>SKU</th>
                <th>Name</th>
                <th>Min Price (Suppliers)</th>
                <th>Max Price (Suppliers)</th>
                <th>Spread %</th>
                <th>Count</th>
            </tr>
        </thead>
        <tbody id="resultsBody">
            {% for item in items %}
            <tr class="product-row" style="background: rgba(255,255,255,0.05); cursor: pointer;"
                onclick="toggleDetails('{{ item.sku }}')">
                <td class="mono" onclick="event.stopPropagation()">
                    <a href="/?q={{ item.sku }}">{{ item.sku }}</a>
                </td>
                <td>{{ item.name }}</td>
                <td>
                    <div class="price-tag">{{ item.min_price }}</div>
                    <div class="supplier-name">{{ item.min_suppliers }}</div>
                </td>
                <td>
                    <div class="price-tag">{{ item.max_price }}</div>
                    <div class="supplier-name">{{ item.max_suppliers }}</div>
                </td>
                <td>
                    <b style="color: var(--warning-color)">{{ item.spread_pct }}%</b>
                </td>
                <td>{{ item.suppliers_cnt }}</td>
                <td style="text-align: center; vertical-align: middle;">
                    <button class="btn-action"
                        style="background: transparent; border: 1px solid #888; color: #888; cursor: pointer; border-radius: 4px; padding: 4px 8px;">‚ñº</button>
                </td>
            </tr>
            <tr id="details-{{ item.sku }}" class="details-row" style="display: none;">
                <td colspan="7"
                    style="padding: 10px 20px; border-bottom: 2px solid var(--border-color); background: rgba(0,0,0,0.1);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; opacity: 0.8;">–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</h4>
                        <button class="btn-action" onclick="showHistory('{{ item.sku }}')"
                            style="background: var(--bg-card); border: 1px solid var(--accent-color); color: var(--accent-color); cursor: pointer; border-radius: 4px; padding: 6px 12px; font-weight: bold;">üìä
                            –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ü–µ–Ω</button>
                    </div>
                    <table class="suppliers-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <th style="text-align: left; padding: 8px;">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                <th style="text-align: left; padding: 8px;">–ê—Ä—Ç–∏–∫—É–ª</th>
                                <th style="text-align: right; padding: 8px;">–¶–µ–Ω–∞</th>
                                <th style="text-align: right; padding: 8px;">–∫–æ–ª-–≤–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set raw_suppliers = item.suppliers_json|fromjson %}
                            {# Filter out My Sklad #}
                            {% set filtered_sups = [] %}
                            {% for s in raw_suppliers %}
                            {% if s.supplier.lower() != '–º–æ–π —Å–∫–ª–∞–¥' %}
                            {% set _ = filtered_sups.append(s) %}
                            {% endif %}
                            {% endfor %}

                            {# Sorting: In-stock first, then price #}
                            {% set in_stock = filtered_sups|selectattr('qty', 'gt', 0)|sort(attribute='price') %}
                            {% set out_of_stock = filtered_sups|selectattr('qty', 'le', 0)|sort(attribute='price') %}

                            {% for s in in_stock + out_of_stock %}
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <td style="padding: 6px 8px;">{{ s.supplier }}</td>
                                <td style="padding: 6px 8px; font-family: monospace; font-size: 0.9em;">{{
                                    s.supplier_sku }}</td>
                                <td style="padding: 6px 8px; text-align: right; font-weight: bold;">
                                    {% if s.currency != 'RUB' %}
                                    <span style="font-size: 0.9em; opacity: 0.8; font-weight: normal;">{{
                                        s.original_price }} {{ s.currency }}</span>
                                    <span style="margin: 0 4px; opacity: 0.5;">‚Üí</span>
                                    {% endif %}
                                    {{ s.price }} <span style="font-size: 0.8em; opacity: 0.6;">RUB</span>
                                </td>
                                <td
                                    style="padding: 6px 8px; text-align: right; color: {% if s.qty > 0 %}#4caf50{% else %}#f44336{% endif %};">
                                    {{ s.qty }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div id="history-{{ item.sku }}" style="margin-top: 15px; display: none;"></div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if total_pages > 1 %}
    <div class="pagination">
        <a href="{{ url_for('report_spread', page=page-1, threshold=threshold, limit=limit, max_price=max_price, in_stock_only=in_stock_only, exclude=exclude_list) }}"
            class="pagination-btn {% if page == 1 %}disabled{% endif %}">‚Üê –ù–∞–∑–∞–¥</a>

        {% for p in range(1, total_pages + 1) %}
        {% if p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %} <a
            href="{{ url_for('report_spread', page=p, threshold=threshold, limit=limit, max_price=max_price, in_stock_only=in_stock_only, exclude=exclude_list) }}"
            class="pagination-btn {% if p == page %}active{% endif %}">{{ p }}</a>
            {% elif p == page - 3 or p == page + 3 %}
            <span style="color: var(--text-secondary)">...</span>
            {% endif %}
            {% endfor %}

            <a href="{{ url_for('report_spread', page=page+1, threshold=threshold, limit=limit, max_price=max_price, in_stock_only=in_stock_only, exclude=exclude_list) }}"
                class="pagination-btn {% if page == total_pages %}disabled{% endif %}">–í–ø–µ—Ä–µ–¥ ‚Üí</a>
    </div>
    {% endif %}

    <script>
        document.getElementById('supSearch')?.addEventListener('input', function (e) {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('#supGrid [data-supplier]').forEach(el => {
                const name = el.getAttribute('data-supplier');
                el.style.display = name.includes(q) ? 'flex' : 'none';
            });
        });
    </script>

    <script>
        function toggleDetails(sku) {
            const row = document.getElementById('details-' + sku);
            row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
        }

        function showHistory(sku, days = 7) {
            const container = document.getElementById('history-' + sku);
            const detailsRow = document.getElementById('details-' + sku);

            if (container.style.display === 'block' && arguments.length === 1) {
                container.style.display = 'none';
                return;
            }

            detailsRow.style.display = 'table-row';
            container.style.display = 'block';
            container.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.7;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';

            fetch(`/ui/history?sku=${encodeURIComponent(sku)}&days=${days}`)
                .then(r => r.text())
                .then(html => { container.innerHTML = html; })
                .catch(err => { container.innerHTML = '<div style="color: #f44336; padding: 10px;">–û—à–∏–±–∫–∞: ' + err + '</div>'; });
        }
    </script>
    {% endblock %}