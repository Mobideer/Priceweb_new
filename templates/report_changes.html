{% extends "base.html" %}

{% block title %}Report: Price Changes - PriceWeb New{% endblock %}

{% block content %}
<h2>Report: Price Changes</h2>
<div style="color:#8b949e; margin-bottom:10px;">
    Shows items with price changes > {{ threshold }}% over the last {{ days }} days.
</div>

<form class="toolbar" method="get" id="filterForm">
    <div style="display: flex; gap: 10px; margin-right: 20px;">
        <a href="?type=all&days={{ days }}&threshold={{ threshold }}"
            class="btn-tab {% if type == 'all' %}active{% endif %}"
            style="{% if type == 'all' %}background: var(--accent-color); color: white; border-color: var(--accent-color);{% endif %}">
            All
        </a>
        <a href="?type=min_price&days={{ days }}&threshold={{ threshold }}"
            class="btn-tab {% if type == 'min_price' %}active{% endif %}"
            style="{% if type == 'min_price' %}background: var(--accent-color); color: white; border-color: var(--accent-color);{% endif %}">
            Market Price
        </a>
        <a href="?type=our_price&days={{ days }}&threshold={{ threshold }}"
            class="btn-tab {% if type == 'our_price' %}active{% endif %}"
            style="{% if type == 'our_price' %}background: var(--accent-color); color: white; border-color: var(--accent-color);{% endif %}">
            Our Price
        </a>
        <input type="hidden" name="type" value="{{ type }}">
    </div>

    <div>
        <label>Threshold %</label>
        <input name="threshold" value="{{ threshold }}" style="width: 80px;">
    </div>
    <div>
        <label>Days Lookback</label>
        <input name="days" value="{{ days }}" style="width: 80px;">
    </div>
    <button type="submit" class="primary">Update</button>
</form>

<style>
    .btn-tab {
        padding: 6px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        text-decoration: none;
        color: var(--text-main);
        transition: all 0.2s;
        display: inline-block;
        background: var(--bg-card);
    }

    .btn-tab:hover {
        background: var(--bg-hover);
        text-decoration: none;
    }
</style>

<div class="total-summary">
    Found: <b>{{ items|length }}</b> events
</div>

<table>
    <thead>
        <tr>
            <th>Date</th>
            <th>Type</th>
            <th>SKU</th>
            <th>Name</th>
            <th>Old Price <span style="font-weight:normal; font-size:0.8em">(Supplier)</span></th>
            <th>New Price <span style="font-weight:normal; font-size:0.8em">(Supplier)</span></th>
            <th>Change %</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="resultsBody">
        {% for item in items %}
        <tr class="product-row" onclick="toggleDetails('{{ item.sku }}_{{ loop.index }}')" style="cursor: pointer;">
            <td style="white-space: nowrap; color: #8b949e; font-size: 0.9em;">
                {{ item.date }}
            </td>
            <td>
                {% if item.type == 'min_price' %}
                <span
                    style="background: rgba(33, 150, 243, 0.2); color: #64b5f6; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">Market</span>
                {% else %}
                <span
                    style="background: rgba(76, 175, 80, 0.2); color: #81c784; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">Our</span>
                {% endif %}
            </td>
            <td class="mono" onclick="event.stopPropagation()">
                <a href="/?q={{ item.sku }}">{{ item.sku }}</a>
            </td>
            <td>{{ item.name }}</td>
            <td style="text-align: right; opacity: 0.7;">
                <div>{{ item.old_price }}</div>
                <div style="font-size: 0.8em; color: #8b949e;">{{ item.old_supplier }}</div>
            </td>
            <td style="text-align: right; font-weight: bold;">
                <div>{{ item.new_price }}</div>
                <div style="font-size: 0.8em; color: #8b949e;">{{ item.new_supplier }}</div>
            </td>
            <td style="text-align: right;">
                {% if item.diff_pct > 0 %}
                <span style="color: #f44336">+{{ item.diff_pct }}% üìà</span>
                {% else %}
                <span style="color: #4caf50">{{ item.diff_pct }}% üìâ</span>
                {% endif %}
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button class="btn-action"
                    style="background: transparent; border: 1px solid #888; color: #888; cursor: pointer; border-radius: 4px; padding: 4px 8px;">‚ñº</button>
            </td>
        </tr>
        <tr id="details-{{ item.sku }}_{{ loop.index }}" class="details-row" style="display: none;">
            <td colspan="8"
                style="padding: 10px 20px; border-bottom: 2px solid var(--border-color); background: rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; opacity: 0.8;">–¢–µ–∫—É—â–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (Latest)</h4>
                    <button class="btn-action"
                        onclick="showHistory('{{ item.sku }}', '{{ item.sku }}_{{ loop.index }}')"
                        style="background: var(--bg-card); border: 1px solid var(--accent-color); color: var(--accent-color); cursor: pointer; border-radius: 4px; padding: 6px 12px; font-weight: bold;">üìä
                        –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ü–µ–Ω</button>
                </div>
                <table class="suppliers-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <th style="text-align: left; padding: 8px;">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                            <th style="text-align: left; padding: 8px;">–ê—Ä—Ç–∏–∫—É–ª</th>
                            <th style="text-align: right; padding: 8px;">–¶–µ–Ω–∞</th>
                            <th style="text-align: right; padding: 8px;">–∫–æ–ª-–≤–æ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set raw_suppliers = item.suppliers_json|fromjson %}
                        {# Filter out My Sklad #}
                        {% set filtered_sups = [] %}
                        {% for s in raw_suppliers %}
                        {% if s.supplier.lower() != '–º–æ–π —Å–∫–ª–∞–¥' %}
                        {% set _ = filtered_sups.append(s) %}
                        {% endif %}
                        {% endfor %}

                        {# Sorting: In-stock first, then price #}
                        {% set in_stock = filtered_sups|selectattr('qty', 'gt', 0)|sort(attribute='price') %}
                        {% set out_of_stock = filtered_sups|selectattr('qty', 'le', 0)|sort(attribute='price') %}

                        {% for s in in_stock + out_of_stock %}
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 6px 8px;">{{ s.supplier }}</td>
                            <td style="padding: 6px 8px; font-family: monospace; font-size: 0.9em;">{{ s.supplier_sku }}
                            </td>
                            <td style="padding: 6px 8px; text-align: right; font-weight: bold;">
                                {% if s.currency != 'RUB' %}
                                <span style="font-size: 0.9em; opacity: 0.8; font-weight: normal;">{{ s.original_price
                                    }} {{ s.currency }}</span>
                                <span style="margin: 0 4px; opacity: 0.5;">‚Üí</span>
                                {% endif %}
                                {{ s.price }} <span style="font-size: 0.8em; opacity: 0.6;">RUB</span>
                            </td>
                            <td
                                style="padding: 6px 8px; text-align: right; color: {% if s.qty > 0 %}#4caf50{% else %}#f44336{% endif %};">
                                {{ s.qty }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div id="history-{{ item.sku }}_{{ loop.index }}" style="margin-top: 15px; display: none;"></div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if not items %}
<div style="text-align: center; padding: 40px; color: #8b949e;">
    No sharp price changes found in this period.
</div>
{% endif %}

<script>
    function toggleDetails(id) {
        const row = document.getElementById('details-' + id);
        row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
    }

    function showHistory(sku, uniqueId, days = 7) {
        const container = document.getElementById('history-' + uniqueId);
        const detailsRow = document.getElementById('details-' + uniqueId);

        if (container.style.display === 'block' && arguments.length === 2) {
            container.style.display = 'none';
            return;
        }

        detailsRow.style.display = 'table-row';
        container.style.display = 'block';
        container.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.7;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';

        fetch(`/ui/history?sku=${encodeURIComponent(sku)}&days=${days}`)
            .then(r => r.text())
            .then(html => { container.innerHTML = html; })
            .catch(err => { container.innerHTML = '<div style="color: #f44336; padding: 10px;">–û—à–∏–±–∫–∞: ' + err + '</div>'; });
    }
</script>

{% endblock %}