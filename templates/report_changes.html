{% extends "base.html" %}

{% block title %}Report: Price Changes - PriceWeb New{% endblock %}

{% block content %}
<h2>Report: Price Changes</h2>
<div style="color:#8b949e; margin-bottom:10px;">
    Shows items with price changes > {{ threshold }}% over the last {{ days }} days.
</div>

<form class="toolbar" method="get" id="filterForm">
    <div style="display: flex; gap: 10px; margin-right: 20px;">
        <a href="?type=all&days={{ days }}&threshold={{ threshold }}"
            class="btn-tab {% if type == 'all' %}active{% endif %}"
            style="{% if type == 'all' %}background: var(--accent-color); color: white; border-color: var(--accent-color);{% endif %}">
            All
        </a>
        <a href="?type=min_price&days={{ days }}&threshold={{ threshold }}"
            class="btn-tab {% if type == 'min_price' %}active{% endif %}"
            style="{% if type == 'min_price' %}background: var(--accent-color); color: white; border-color: var(--accent-color);{% endif %}">
            Market Price
        </a>
        <a href="?type=our_price&days={{ days }}&threshold={{ threshold }}"
            class="btn-tab {% if type == 'our_price' %}active{% endif %}"
            style="{% if type == 'our_price' %}background: var(--accent-color); color: white; border-color: var(--accent-color);{% endif %}">
            Our Price
        </a>
        <input type="hidden" name="type" value="{{ type }}">
    </div>

    <div>
        <label>Threshold %</label>
        <input name="threshold" value="{{ threshold }}" style="width: 80px;">
    </div>
    <div>
        <label>Days Lookback</label>
        <input name="days" value="{{ days }}" style="width: 80px;">
    </div>
    <button type="submit" class="primary">Update</button>
</form>

<style>
    .btn-tab {
        padding: 6px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        text-decoration: none;
        color: var(--text-main);
        transition: all 0.2s;
        display: inline-block;
        background: var(--bg-card);
    }

    .btn-tab:hover {
        background: var(--bg-hover);
        text-decoration: none;
    }
</style>

<div class="total-summary">
    Found: <b>{{ items|length }}</b> events
</div>

<table>
    <thead>
        <tr>
            <th style="cursor: pointer;" onclick="handleSort('date')">Date <span id="sort-date"
                    class="sort-icon">‚áÖ</span></th>
            <th>Type</th>
            <th style="cursor: pointer;" onclick="handleSort('sku')">SKU/Name <span id="sort-sku"
                    class="sort-icon">‚áÖ</span></th>
            <th>Name</th>
            <th style="text-align: right; cursor: pointer;" onclick="handleSort('old_price')">Old Price <span
                    id="sort-old_price" class="sort-icon">‚áÖ</span></th>
            <th style="text-align: right; cursor: pointer;" onclick="handleSort('new_price')">New Price <span
                    id="sort-new_price" class="sort-icon">‚áÖ</span></th>
            <th style="text-align: right; cursor: pointer;" onclick="handleSort('diff')">Change % <span id="sort-diff"
                    class="sort-icon">‚áÖ</span></th>
            <th></th>
        </tr>
        <tr class="filter-row">
            <th><input id="filter-date" oninput="handleFilter()" placeholder="Date..."
                    style="width:100%; box-sizing:border-box;"></th>
            <th></th>
            <th colspan="2"><input id="filter-sku" oninput="handleFilter()" placeholder="Filter Name or SKU..."
                    style="width:100%; box-sizing:border-box;"></th>
            <th><input id="filter-old-price" oninput="handleFilter()" placeholder="Price..."
                    style="width:100%; box-sizing:border-box; text-align:right;"></th>
            <th><input id="filter-new-price" oninput="handleFilter()" placeholder="Price..."
                    style="width:100%; box-sizing:border-box; text-align:right;"></th>
            <th><input id="filter-diff" oninput="handleFilter()" placeholder=">10 or <-5"
                    style="width:100%; box-sizing:border-box; text-align:right;"></th>
            <th></th>
        </tr>
    </thead>
    <tbody id="resultsBody">
        {% for item in items %}
        <tr class="product-row" onclick="toggleDetails('{{ item.sku }}_{{ loop.index }}')" style="cursor: pointer;">
            <td style="white-space: nowrap; color: #8b949e; font-size: 0.9em;">
                {{ item.date }}
            </td>
            <td>
                {% if item.type == 'min_price' %}
                <span
                    style="background: rgba(33, 150, 243, 0.2); color: #64b5f6; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">Market</span>
                {% else %}
                <span
                    style="background: rgba(76, 175, 80, 0.2); color: #81c784; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">Our</span>
                {% endif %}
            </td>
            <td class="mono" onclick="event.stopPropagation()">
                <a href="/?q={{ item.sku }}">{{ item.sku }}</a>
            </td>
            <td style="word-break: break-word; overflow-wrap: anywhere;">{{ item.name }}</td>
            <td style="text-align: right; opacity: 0.7;">
                <div>{{ item.old_price }}</div>
                <div style="font-size: 0.8em; color: #8b949e;">{{ item.old_supplier }}</div>
            </td>
            <td style="text-align: right; font-weight: bold;">
                <div>{{ item.new_price }}</div>
                <div style="font-size: 0.8em; color: #8b949e;">{{ item.new_supplier }}</div>
            </td>
            <td style="text-align: right;">
                {% if item.diff_pct > 0 %}
                <span style="color: #f44336">Œî {{ item.diff_pct|abs }}% üìà</span>
                {% else %}
                <span style="color: #4caf50">Œî {{ item.diff_pct|abs }}% üìâ</span>
                {% endif %}
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button class="btn-action"
                    style="background: transparent; border: 1px solid #888; color: #888; cursor: pointer; border-radius: 4px; padding: 4px 8px;">‚ñº</button>
            </td>
        </tr>
        <tr id="details-{{ item.sku }}_{{ loop.index }}" class="details-row" style="display: none;">
            <td colspan="8"
                style="padding: 10px 20px; border-bottom: 2px solid var(--border-color); background: rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; opacity: 0.8;">–¢–µ–∫—É—â–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (Latest)</h4>
                    <button class="btn-action"
                        onclick="showHistory('{{ item.sku }}', '{{ item.sku }}_{{ loop.index }}')"
                        style="background: var(--bg-card); border: 1px solid var(--accent-color); color: var(--accent-color); cursor: pointer; border-radius: 4px; padding: 6px 12px; font-weight: bold;">üìä
                        –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ü–µ–Ω</button>
                </div>
                <table class="suppliers-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <th style="text-align: left; padding: 8px;">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                            <th style="text-align: left; padding: 8px;">–ê—Ä—Ç–∏–∫—É–ª</th>
                            <th style="text-align: right; padding: 8px;">–¶–µ–Ω–∞</th>
                            <th style="text-align: right; padding: 8px;">–∫–æ–ª-–≤–æ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set raw_suppliers = item.suppliers_json|fromjson %}
                        {# Filter out My Sklad #}
                        {% set filtered_sups = [] %}
                        {% for s in raw_suppliers %}
                        {% if s.supplier.lower() != '–º–æ–π —Å–∫–ª–∞–¥' %}
                        {% set _ = filtered_sups.append(s) %}
                        {% endif %}
                        {% endfor %}

                        {# Sorting: In-stock first, then price #}
                        {% set in_stock = filtered_sups|selectattr('qty', 'gt', 0)|sort(attribute='price') %}
                        {% set out_of_stock = filtered_sups|selectattr('qty', 'le', 0)|sort(attribute='price') %}

                        {% for s in in_stock + out_of_stock %}
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 6px 8px;">{{ s.supplier }}</td>
                            <td style="padding: 6px 8px; font-family: monospace; font-size: 0.9em;">{{ s.supplier_sku }}
                            </td>
                            <td style="padding: 6px 8px; text-align: right; font-weight: bold;">
                                {% if s.currency != 'RUB' %}
                                <span style="font-size: 0.9em; opacity: 0.8; font-weight: normal;">{{ s.original_price
                                    }} {{ s.currency }}</span>
                                <span style="margin: 0 4px; opacity: 0.5;">‚Üí</span>
                                {% endif %}
                                {{ s.price }} <span style="font-size: 0.8em; opacity: 0.6;">RUB</span>
                            </td>
                            <td
                                style="padding: 6px 8px; text-align: right; color: {% if s.qty > 0 %}#4caf50{% else %}#f44336{% endif %};">
                                {{ s.qty }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div id="history-{{ item.sku }}_{{ loop.index }}" style="margin-top: 15px; display: none;"></div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if not items %}
<div style="text-align: center; padding: 40px; color: #8b949e;">
    No sharp price changes found in this period.
</div>
{% endif %}

<script src="{{ url_for('static', filename='js/table_filters.js') }}"></script>
<script>
    // Initialize data
    let currentData = {{ items | tojson | safe }};
    let currentSort = { column: null, asc: true };
    const resultsBody = document.getElementById('resultsBody');

    // Initial render
    document.addEventListener('DOMContentLoaded', () => {
        renderResults(currentData);
    });

    function toggleDetails(id) {
        const row = document.getElementById('details-' + id);
        if (row) row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
    }

    function showHistory(sku, uniqueId, days = 7) {
        // ... (existing showHistory logic)
        const container = document.getElementById('history-' + uniqueId);
        const detailsRow = document.getElementById('details-' + uniqueId);

        if (container.style.display === 'block' && arguments.length === 2) {
            container.style.display = 'none';
            return;
        }

        detailsRow.style.display = 'table-row';
        container.style.display = 'block';
        container.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.7;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';

        fetch(`/ui/history?sku=${encodeURIComponent(sku)}&days=${days}`)
            .then(r => r.text())
            .then(html => { container.innerHTML = html; })
            .catch(err => { container.innerHTML = '<div style="color: #f44336; padding: 10px;">–û—à–∏–±–∫–∞: ' + err + '</div>'; });
    }

    function handleFilter() {
        const filters = {
            date: document.getElementById('filter-date')?.value.toLowerCase() || '',
            sku: document.getElementById('filter-sku')?.value.toLowerCase() || '',
            old_price: document.getElementById('filter-old-price')?.value || '',
            new_price: document.getElementById('filter-new-price')?.value || '',
            diff: document.getElementById('filter-diff')?.value || ''
        };

        let filteredItems = currentData.filter(item => {
            if (filters.date && !item.date.toLowerCase().includes(filters.date)) return false;

            // SKU or Name
            if (filters.sku) {
                const term = filters.sku;
                if (!item.sku.toLowerCase().includes(term) && !item.name.toLowerCase().includes(term)) return false;
            }

            if (!FilterUtils.checkPriceOrQty(filters.old_price, item.old_price, 0)) return false; // No qty for old price easily avail
            if (!FilterUtils.checkPriceOrQty(filters.new_price, item.new_price, 0)) return false;

            if (filters.diff) {
                // Filter by Diff %, allow operators
                if (!FilterUtils.parseOperator(filters.diff, item.diff_pct)) return false;
            }

            return true;
        });

        // Apply Sorting
        if (currentSort.column) {
            filteredItems.sort((a, b) => {
                let valA = getSortValue(a, currentSort.column);
                let valB = getSortValue(b, currentSort.column);

                if (typeof valA === 'number' && typeof valB === 'number') {
                    return currentSort.asc ? valA - valB : valB - valA;
                }
                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();
                if (valA < valB) return currentSort.asc ? -1 : 1;
                if (valA > valB) return currentSort.asc ? 1 : -1;
                return 0;
            });
        }

        renderResults(filteredItems);
    }

    function getSortValue(item, column) {
        switch (column) {
            case 'date': return item.date;
            case 'sku': return item.name; // Sort by name effectively
            case 'old_price': return item.old_price;
            case 'new_price': return item.new_price;
            case 'diff': return item.diff_pct;
            default: return '';
        }
    }

    function handleSort(column) {
        if (currentSort.column === column) {
            currentSort.asc = !currentSort.asc;
        } else {
            currentSort.column = column;
            currentSort.asc = true;
        }
        updateSortIcons();
        handleFilter(); // Re-apply filters and sort
    }

    function updateSortIcons() {
        document.querySelectorAll('.sort-icon').forEach(el => el.textContent = '‚áÖ');
        if (currentSort.column) {
            const el = document.getElementById('sort-' + currentSort.column);
            if (el) el.textContent = currentSort.asc ? '‚ñ≤' : '‚ñº';
        }
    }

    function renderResults(items) {
        if (!items || items.length === 0) {
            resultsBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">No matching records</td></tr>';
            document.querySelector('.total-summary b').textContent = '0';
            return;
        }

        document.querySelector('.total-summary b').textContent = items.length;
        let html = '';

        items.forEach((item, index) => {
            const uniqueId = item.sku + '_' + index;
            // Reconstruct HTML for row
            const typeBadge = item.type === 'min_price'
                ? '<span style="background: rgba(33, 150, 243, 0.2); color: #64b5f6; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">Market</span>'
                : '<span style="background: rgba(76, 175, 80, 0.2); color: #81c784; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">Our</span>';

            const diffDisplay = item.diff_pct > 0
                ? `<span style="color: #f44336">Œî ${item.diff_pct}% üìà</span>`
                : `<span style="color: #4caf50">${item.diff_pct}% üìâ</span>`;

            // We need to parse suppliers again for the details row
            let suppliersHtml = '';
            try {
                let suppliers = JSON.parse(item.suppliers_json || '[]');
                suppliers = suppliers.filter(s => s.supplier.toLowerCase() !== '–º–æ–π —Å–∫–ª–∞–¥');
                suppliers.sort((a, b) => {
                    const aStock = a.qty > 0 ? 1 : 0;
                    const bStock = b.qty > 0 ? 1 : 0;
                    if (aStock !== bStock) return bStock - aStock;
                    return a.price - b.price;
                });

                suppliers.forEach(s => {
                    const priceDisplay = s.currency !== 'RUB'
                        ? `<span style="font-size: 0.9em; opacity: 0.8; font-weight: normal; color: var(--text-color);">${s.original_price} ${s.currency}</span> <span style="margin: 0 4px; opacity: 0.5; color: var(--text-color);">‚Üí</span> ${s.price} <span style="font-size: 0.8em; opacity: 0.6;">RUB</span>`
                        : `${s.price} <span style="font-size: 0.8em; opacity: 0.6;">RUB</span>`;

                    let priceStyle = 'padding: 6px 8px; text-align: right; font-weight: bold;';
                    if (item.current_our_price && s.price) {
                        if (s.price < item.current_our_price) priceStyle += ' color: var(--success-color);';
                        else if (s.price > item.current_our_price) priceStyle += ' color: var(--danger-color);';
                    }

                    suppliersHtml += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 6px 8px;">${s.supplier}</td>
                        <td style="padding: 6px 8px; font-family: monospace; font-size: 0.9em;">
                            ${s.supplier_sku || ''}
                            ${s.product_name ? `<div style="font-family: sans-serif; font-size: 0.85em; color: var(--text-muted); margin-top: 2px;">${s.product_name}</div>` : ''}
                        </td>
                        <td style="${priceStyle}">${priceDisplay}</td>
                        <td style="padding: 6px 8px; text-align: right; color: ${s.qty > 0 ? '#4caf50' : '#f44336'};">${s.qty}</td>
                    </tr>`;
                });
            } catch (e) { console.error(e); }

            html += `
            <tr class="product-row" onclick="toggleDetails('${uniqueId}')" style="cursor: pointer;">
                <td style="white-space: nowrap; color: #8b949e; font-size: 0.9em;">${item.date}</td>
                <td>${typeBadge}</td>
                <td class="mono" onclick="event.stopPropagation()"><a href="/?q=${item.sku}">${item.sku}</a></td>
                <td style="word-break: break-word; overflow-wrap: anywhere;">${item.name}</td>
                <td style="text-align: right; opacity: 0.7;">
                    <div>${item.old_price}</div>
                    <div style="font-size: 0.8em; color: #8b949e;">${item.old_supplier}</div>
                </td>
                <td style="text-align: right; font-weight: bold;">
                    <div>${item.new_price}</div>
                    <div style="font-size: 0.8em; color: #8b949e;">${item.new_supplier}</div>
                </td>
                <td style="text-align: right;">${diffDisplay}</td>
                <td style="text-align: center; vertical-align: middle;">
                    <button class="btn-action" style="background: transparent; border: 1px solid #888; color: #888; cursor: pointer; border-radius: 4px; padding: 4px 8px;">‚ñº</button>
                </td>
            </tr>
            <tr id="details-${uniqueId}" class="details-row" style="display: none;">
                <td colspan="8" style="padding: 10px 20px; border-bottom: 2px solid var(--border-color); background: rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; opacity: 0.8;">–¢–µ–∫—É—â–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (Latest)</h4>
                        <button class="btn-action" onclick="showHistory('${item.sku}', '${uniqueId}')"
                            style="background: var(--bg-card); border: 1px solid var(--accent-color); color: var(--accent-color); cursor: pointer; border-radius: 4px; padding: 6px 12px; font-weight: bold;">üìä –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ü–µ–Ω</button>
                    </div>
                    <table class="suppliers-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <th style="text-align: left; padding: 8px;">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                <th style="text-align: left; padding: 8px;">–ê—Ä—Ç–∏–∫—É–ª</th>
                                <th style="text-align: right; padding: 8px;">–¶–µ–Ω–∞</th>
                                <th style="text-align: right; padding: 8px;">–∫–æ–ª-–≤–æ</th>
                            </tr>
                        </thead>
                        <tbody>${suppliersHtml}</tbody>
                    </table>
                    <div id="history-${uniqueId}" style="margin-top: 15px; display: none;"></div>
                </td>
            </tr>`;
        });
        resultsBody.innerHTML = html;
    }

</script>

{% endblock %}